image: registry.gitlab.com/satoshilabs/trezor/trezor-firmware/trezor-firmware-env.nix

# Caching
.gitlab_caching: &gitlab_caching
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - .venv/

# Hardware
hardware core monero test:
  stage: test
  only:
    - schedules  # nightly build
    - /^release\//
    - /^secfix\//
    - /^hw\//
  tags:
    - tpmb
  needs:
    - core fw regular debug build
  variables:
    TESTOPTS: --trezor-path webusb
  script:
    - cd ci/hardware_tests
    - set -a
    - source hardware.cfg
    - set +a
    - $NIX_SHELL --run "cd ../.. && poetry install"
    - $NIX_SHELL --run "poetry run python bootstrap.py tt ../../firmware-T2*.bin | ts -s"
    - $NIX_SHELL --arg fullDeps true --run "cd ../../core/tests && ./run_tests_device_emu_monero.sh $TESTOPTS | ts -s"
  timeout: 1h
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    expire_in: 2 days
    when: always
